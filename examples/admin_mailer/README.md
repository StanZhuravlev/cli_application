# Работа с электронной почтой из CLI-скрипта

### Содержание

* [Проверка возможности отправить письмо](#toc1)
* [Запись почтовых сообщений в лог-файл](#toc2)

# Общее описание

В этой папке представлен набор скриптов для демонстрации подсистемы электронной почты библиотеки CliApplication.
Одной из задач, с которой я сталкивался в повседненой работе - необходимость посылать разные алерты алимнистратору
в случае ошибок, настпуления каких-либо событий и пр. Соответственно - необхдимо было включить в CliApplication
библиотеку для отправки почтовых сообщений.

Чем не устраивали существующие гемы, например, `Mail` или `ActionMailer`? Отличные библиотеки, но... избыточные. Тянут
много зависимостей, много весят. Нужно было что-то попроще и быстрее. В итоге, была сделана своя подсистема отправки
электронных сообщений.

Чем она хороша?

* Возможность отправки писем через SMTP и Sendmail
* Возможность быстро отключить отправку писем по всем скриптам базового класса (например, для срочного исправления ошибок)
* Возможность быстро перенаправить вывод всех писем в лог-файл
* Автоматическое human-преобразование HTML-текста в обычный plain-текст (возможен корректный просмотр через текстовую консоль)

Чем плоха?

* Не позволяет делать attach файлов
* Не обеспечивает защиту от MIME-инжекций
* Не обесечивает "санитарную" обработку HTML

Другими словами - эта библиотека для отправки писем адимнистратору и ответственным пользователям.

Рассмотрим на конкретных примерах работу подсистемы электронной почты библиотеки CliApplication.

## [Проверка возможности отправить письмо](#toc1)

Сначала проверим, можем ли отправлять письма без специальных настроек в конфиге. Для этого напишем с использованием
библиотеки `CliApplication` следующее приложение.

```ruby
class TestValid < CliExample

  def main

    if mail.valid?
      puts "Выбран способ отправки почты: #{mail.delivery_method}"
    else
      puts mail.config_fail_message
    end

    return 0
  end

end

app = TestValid.new(ARGV, __dir__)

app.version = '1.0'
app.releasedate = '2015-06-09'
app.shortdescription = 'Проверяем настройки почтовой подсистемы'
app.description = "Класс CliApplication\n#{app.shortdescription}"

app.help

app.run
exit(app.exitcode)
```

Запустим его, и получим следующий результат:

```
test_valid.rb - Проверяем настройки почтовой подсистемы
Версия 1.0 (2015-06-09)
Последний запуск: 10 июня 2015 г. 00:49:28 (21 секунда назад)
Всего было 7 запусков

Класс CliApplication
Проверяем настройки почтовой подсистемы

Не найдена секция mail
```

Что было сделано? При запуске приложения осуществляется проверка основного конфиг-файла, и, в частности, наличие в нем
секции `cli/mail`. В данном случае, такой секции в конфиге нет. Поэтому метод `mail.valid?` возращает `false`,
при этом в переменной `mail.config_fail_message` находится текст ошибки.

Создадим теперь секцию `cli/mail`, и запустим скрипт вновь.

```
Отсутствует параметр enable в секции mail
```

Данный параметр определяет - нужно ли отправлять почту (`true`) или остановить отправку  (`false`). Это нужно на случай,
если произошла какая-то ошибка, и стало передаваться слишком много алертов. В этом случае можно быстро перевести данное значение
в `false` и уменьшить объем присылаемой почты.

Добавим данный ключ и запустим приложение опять. что мы видим?

```
Метод доставки должен быть один из: ["log", "sendmail", "smtp"]
```

Это второй обязательный параметр. Он выбирает один из трех способов отправки письма, доступных в бибилиотеке CliAppliction.
Сначала сделаем самый простой вариант - запись в лог-файл. Укажем `delivery_method=log`. Проверим, что получилось.

```
Отсутствует параметр from в секции mail
```

Последний обязательный параметр - `from`. В этой строке должен быть записан адрес, от имени которого будут рассылаться все письма.
Адрес может быть указан как в формате `user@host.ru`, так и в формате `User Name <user@host.ru>`. Подсистема электронной почты
корректно опредлит формат адреса и обработает его. Пишем `` и запускаем опять.

```
Не найдена секция конфиг-файла cli/mail/log
```

Уже лучше - настройка подсистемы прошла успешно. Мы видим ошибочное сообщение уже от подсистемы записи почтовых сообщений в лог.
Поэтому сделаем следующий шаг...

## [Запись почтовых сообщений в лог-файл](#toc2)

автоматическое создание папки для логирования сообщений электронной почты
enable
config_mail_message
html/plain