# Работа с электронной почтой из CLI-скрипта

### Содержание

* [Проверка возможности отправить письмо](#toc1)
* [Запись почтовых сообщений в лог-файл](#toc2)
* [Подпись письма (footer)](#toc3)
* [Отправка через SMTP (без пароля)](#toc4)
* [Отправка через внешний SMTP](#toc5)
  * [через Mail.ru](#toc6)
* [Отправка через Sendmail](#toc7)
* [Другие особенности](#toc8)

# Общее описание

В этой папке представлен набор скриптов для демонстрации подсистемы электронной почты библиотеки CliApplication.
Одной из задач, с которой я сталкивался в повседненой работе - необходимость посылать разные алерты алимнистратору
в случае ошибок, настпуления каких-либо событий и пр. Соответственно - необхдимо было включить в CliApplication
библиотеку для отправки почтовых сообщений.

Чем не устраивали существующие гемы, например, `Mail` или `ActionMailer`? Отличные библиотеки, но... избыточные. Тянут
много зависимостей, много весят. Нужно было что-то попроще и быстрее. В итоге, была сделана своя подсистема отправки
электронных сообщений.

Чем она хороша?

* Возможность отправки писем через SMTP и Sendmail
* Возможность быстро отключить отправку писем по всем скриптам базового класса (например, для срочного исправления ошибок)
* Возможность быстро перенаправить вывод всех писем в лог-файл
* Автоматическое human-преобразование HTML-текста в обычный plain-текст (возможен корректный просмотр через текстовую консоль)

Чем плоха?

* Не позволяет делать attach файлов
* Не обеспечивает защиту от MIME-инжекций
* Не обесечивает "санитарную" обработку HTML

Другими словами - эта библиотека для отправки писем адимнистратору и ответственным пользователям.

Рассмотрим на конкретных примерах работу подсистемы электронной почты библиотеки CliApplication.

## <a name="toc1"/>Проверка возможности отправить письмо

Сначала проверим, можем ли отправлять письма без специальных настроек в конфиге. Для этого напишем с использованием
библиотеки `CliApplication` следующее приложение.

```ruby
class TestValid < CliExample

  def main

    if mail.valid?
      puts "Выбран способ отправки почты: #{mail.delivery_method}"
    else
      puts mail.config_fail_message
    end

    return 0
  end

end

app = TestValid.new(ARGV, __dir__)

app.version = '1.0'
app.releasedate = '2015-06-09'
app.shortdescription = 'Проверяем настройки почтовой подсистемы'
app.description = "Класс CliApplication\n#{app.shortdescription}"

app.help

app.run
exit(app.exitcode)
```

Запустим его, и получим следующий результат:

```
test_valid.rb - Проверяем настройки почтовой подсистемы
Версия 1.0 (2015-06-09)
Последний запуск: 10 июня 2015 г. 00:49:28 (21 секунда назад)
Всего было 7 запусков

Класс CliApplication
Проверяем настройки почтовой подсистемы

Не найдена секция mail
```

Что было сделано? При запуске приложения осуществляется проверка основного конфиг-файла, и, в частности, наличие в нем
секции `cli/mail`. В данном случае, такой секции в конфиге нет. Поэтому метод `mail.valid?` возращает `false`,
при этом в переменной `mail.config_fail_message` находится текст ошибки.

Создадим теперь секцию `cli/mail`, и запустим скрипт вновь.

```
Отсутствует параметр enable в секции mail
```

Данный параметр определяет - нужно ли отправлять почту (`true`) или остановить отправку  (`false`). Это нужно на случай,
если произошла какая-то ошибка, и стало передаваться слишком много алертов. В этом случае можно быстро перевести данное значение
в `false` и уменьшить объем присылаемой почты.

Добавим данный ключ и запустим приложение опять. что мы видим?

```
Метод доставки должен быть один из: ["log", "sendmail", "smtp"]
```

Это второй обязательный параметр. Он выбирает один из трех способов отправки письма, доступных в бибилиотеке CliAppliction.
Сначала сделаем самый простой вариант - запись в лог-файл. Укажем `delivery_method=log`. Проверим, что получилось.

```
Отсутствует параметр from в секции mail
```

Последний обязательный параметр - `from`. В этой строке должен быть записан адрес, от имени которого будут рассылаться все письма.
Адрес может быть указан как в формате `user@host.ru`, так и в формате `User Name <user@host.ru>`. Подсистема электронной почты
корректно опредлит формат адреса и обработает его. Пишем `` и запускаем опять.

```
Не найдена секция конфиг-файла cli/mail/log
```

Уже лучше - настройка подсистемы прошла успешно. Мы видим ошибочное сообщение уже от подсистемы записи
почтовых сообщений в лог. Посмотрим, что у нас получилось в конфиге.

```yaml
cli:
  timezone: "Moscow"

  mail:
    enable: true
    delivery_method: log
    from: 'Cli-Application Notify <admin@cli-application.ru>'
```

## <a name="toc2"/>Запись почтовых сообщений в лог-файл

Вот полный набор ключей конфигурации функций записи почтовых сообщений в лог-файл.

```yaml
cli:
  timezone: "Moscow"

  mail:
    enable: true
    delivery_method: log
    from: 'Cli-Application Notify <admin@cli-application.ru>'

  log:
    location: '****/mail/{exe}-mail-{date}.txt'
```

Здесь все просто - указывается единственный параметр `location`. Данный параметр содержит имя папки, в которую будут
сохраняться почтовые сообщения. Это имя строится на базе шаблона, в котором допускается включение следующих параметров:

* `***` - три звездочки будут заменены на папку, в которой лежит базовый класс. Это позволит сохранять все письма
в единой папке.
* `****` - четыре звездочки будут заменены на папку текущего приложения.
* `{exe}` - шаблонная переменная заменится на имя текущего файла без расширения '.rb'. Указание данной переменной
позволяет разбить лог-файл по каждому приложению.
* `{date}` - шаблонная переменная заменится на текущую дату в формате 'YYYY-MM-DD'. То есть лог-файл будет разбит "по дням"

Важный момент. Если указанная в конфигурации директория не существует, она будет создана автоматически, независимо от
глубины вложенности папки.

Перейдем к непосредственно отправке письма. Для этого сначала давайте создадим функцию
в [базовом классе](/examples/class/cli_example.rb), которая будет проверять корректность настройки почты, и предупреждающий
если есть проблемы с настройкой. Для этого напишем такую функцию.

```ruby
def simple_send(to, name, title, body)
  if mail.valid?
    mail.simple_send(to, name, title, body)
  else
    $stderr.puts "Ошибка отправки письма: #{mail.config_fail_message}"
  end
end
```

Теперь создадим письмо, которое будет использоваться для тестов.

```html
<h1>Уведомление</h1>
<p>Получены следующие алерты</p>
<ul>
<li>Не хватает памяти</li>
<li>Перегрузка процессора</li>
<li>Неисправен HDD</li>
<p>Необходимо <b>срочно</b> принять меры!
```

Создадим тестовый скрипт [test_send_mail.rb](/examples/admin_mailer/test_send_mail.rb), в котором сделаем функцию `main`
следующего содержания.

```ruby
def main
  simple_send('user@host.ru', 'User Name', 'Тестовое письмо', $message_body)
  return 0
end
```

И запустим его.... Что мы видим?

В папке, где лежит приложение `test_send_mail.rb` появилась папка mail. В ней - файл `test-send-mail-mail-2015-06-10.txt`
следующего содержания.

```
--- 10 июня 2015 г. 08:59:56 -------------------
From: Cli-Application Notify <admin@cli-application.ru>
To:   User Name <user@host.ru>
Subj: "Тестовое письмо"
***********
Уведомление
***********

Получены следующие алерты

* Не хватает памяти
* Перегрузка процессора
* Неисправен HDD
Необходимо срочно принять меры!
```

Как видно, наше HTML-письмо преобразовалось в текстовую (консуольную) форму. Что же, мы отправили наше первое письмо.
Пусть хотя бы даже и в файл.

## <a name="toc3"/>Подпись письма (footer)

Через подсистему писем возможно добавить подпись, которая будет добавляться в каждое письмо, отправляемое из
разрабатываемых приложений. Для этого в секцию `mail` конфига необходимо добавить html-код с текстом подписи.
Например, вот так.

```yaml
mail:
  enable: true
  delivery_method: log
  from: 'Cli-Application Notify <admin@cli-application.ru>'
  footer: '<br><hr height="1px" width="250px" align="left">Тестовая подпись от <b>cli_application gem</b>'
```

Файл `test_send_mail.rb` не меняем, и просто запускаем его повторно. фиксируем в файле `test-send-mail-mail-2015-06-10.txt`
новую запись.

```
--- 10 июня 2015 г. 15:46:42 -------------------
From: Cli-Application Notify <admin@cli-application.ru>
To:   User Name <user@host.ru>
Subj: "Тестовое письмо"
***********
Уведомление
***********

Получены следующие алерты

* Не хватает памяти
* Перегрузка процессора
* Неисправен HDD
Необходимо срочно принять меры!

Тестовая подпись от cli_application gem
```

## <a name="toc4"/>Отправка через SMTP (без пароля)

Теперь попробуем отправить полноценное письмо через SMTP протокол. Если SMTP-сервер локальный, то есть работа с ним
не требует указания логина-пароля, то составим такой конфиг:

```yaml
mail:
  enable: true
  delivery_method: smtp
  from: 'Cli-Application Notify <admin@cli-application.ru>'
  footer: '<br><br><hr width="1px">Тестовая подпись от <b>cli_application gem</b>'

  smtp:
    domain: cli-application.ru
    address: smtp.cli-application.ru
    port: 25
    debug: false
```

Мы добавили секцию smtp, и указали `delivery_method: smtp`. Файл `test_send_mail.rb` не меняем никак. В общем-то, это
единственные изменения которые нужно сделать для реальной отправки почты.

Запускаем приложение. Смотрим результаты: в почтовый ящик пришло письмо следующего содержания.

> Отправитель: Cli-Application Notify <admin@cli-application.ru><br>
> Тема: Тестовое письмо<br>
> Дата: 10 Jun 2015 04:05:29 pm GMT+3<br>
> Получатель: User Name <user@host.ru><br>

> <h1>Уведомление</h1>
> <p>Получены следующие алерты</p>
> <ul>
> <li>Не хватает памяти</li>
> <li>Перегрузка процессора</li>
> <li>Неисправен HDD</li>
> </ul>
> <p>Необходимо <b>срочно</b> принять меры!</p>
> <br><hr height="1px" width="250px" align="left">Тестовая подпись от <b>cli_application gem</b>


Посмотрим также содержимое письма.

```html
--NextPart_2605766639589518084_616293
Content-Transfer-Encoding: 8bit
Content-Type: text/plain; charset="utf-8"

***********
Уведомление
***********

Получены следующие алерты

* Не хватает памяти
* Перегрузка процессора
* Неисправен HDD

Необходимо срочно принять меры!

Тестовая подпись от cli_application gem

--NextPart_2605766639589518084_616293
Content-Transfer-Encoding: 8bit
Content-Type: text/html; charset="utf-8"

<h1>Уведомление</h1>
<p>Получены следующие алерты</p>
<ul>
<li>Не хватает памяти</li>
<li>Перегрузка процессора</li>
<li>Неисправен HDD</li>
</ul>
<p>Необходимо <b>срочно</b> принять меры!</p><br><hr height="1px" width="300px" align="left">Тестовая подпись от <b>cli_application gem</b>

--NextPart_2605766639589518084_616293--
```

В теле письма содержится кроме HTML-версии, еще и PLAIN-версия письма, что позволит просматривать его в консольном
приложении. Эта возможность может оказаться полезной для системных администраторов, которые используют telnet в
качестве основного средства администрирования.

## <a name="toc5"/>Отправка через внешний SMTP

Данный раздел содержит примеры настройки подсистемы электронной почты для различных публичных почтовых служб.
Раздел содержит пока только `mail.ru`, но если у кого-то есть опыт интеграции с другими сервисами, просьба сообщить мне,
я опубликую это в данном мануале.

### <a name="toc6"/>Mail.ru

Рассмотрим отправку сообщений через Mail.ru. Составим следующий конфиг:

```yaml
cli:
  mail:
    smtp:
      domain: mail.ru
      address: smtp.mail.ru
      port: 25
      tls: true
      authentication: :login
      user_name: '**********@mail.ru'
      password: '***************'
      debug: false
```

Заметим, что структура конфига полностью совпадает со структурой конфига гема `action_mailer`, что позволяет просто
копировать настройки из проектов Rails в CLI-проекты.

## <a name="toc7"/>Отправка через Sendmail

Отправка писем через SMTP имеет несколько недостатков:
* время отправки до 15-30 секунд, в зависимости от скорости взаимодействия с SMTP-сервером.
* если при отправке произойдет ошибка, письмо будет потеряно. В условиях администрирования серверов это плохо, поскольку
можно пропустить какие-то важные события.

Поэтому предпочтительным является использование `sendmail`. В этом случае, вместо непосредственной отправки в сеть, письмо
через sendmail мгновенно помещается в очередь сообщений, и дальше, рано или поздно сообщения передадутся в сеть.

Для реализации этой возможности сформируем в конфиге секцию `sendmail`, и изменим `delivery_method: sendmail`.

```yaml
cli:
  mail:
    sendmail:
      location: /usr/sbin_maybe/sendmail
      arguments: '-i -t -v'
```

Следует обратить внимание, что в примере выше намерено указана неправильная папка для sendmail. Запустим
`test_send_mail.rb` (который по прежнему остается неизменным).

 ```
Ошибка отправки письма: Не найден sendmail ("/usr/sbin_maybe/sendmail")
 ```

Программа проверила наличие по указанному пути `sendmail` и вывела ошибочное сообщение на экран. Поэтому исправим путь
на корректный, запустим приложение повторно, и убедимся, что почта приходит в почтовый ящик корректно.

ВАЖНО. Еще раз следует отметить, что sendmail только формирует очередь сообщений. Это означает, что даже если
sendmail не настроен - все равно результат исполнения отправки письма будет "success".

Параметр `arguments` конфига задает стандартные ключи пограммы `sendmail`. Минимальный обязательный набор - `-i -t`.

## <a name="toc8"/>Другие особенности

В данном разделе приведены несколько важных рекомендаций по работе с подсистемой электронной почты.

* При отправке писем через SMTP с использованием библиотеки `Net::SMTP`, библиотека накладывает ограничения на
отправку писем с параметрами CC и BCC. Поэтому если в сообщение будут добавлены CC пользователи, они переставятся в TO,
а BCC пользователи будут удалены без предупреждений.
* Секция `cli/mail/smtp` содержит параметр debug. Если установить его в true, то на экран будет выведен обмен сообщениями с
SMTP-сервером. Режим может использоваться для отладки приложений.
* Допускается отправка на несколько адресов. Для этого необходимо оставить пустым поле `name` функции `simple_send`,
и указать всех пользователей в поле TO в виде массива, например `['mail1@host.ru', 'User <user@host.ru>']`

